var Ft=Object.defineProperty;var Wt=(t,e,o)=>e in t?Ft(t,e,{enumerable:!0,configurable:!0,writable:!0,value:o}):t[e]=o;var M=(t,e,o)=>Wt(t,typeof e!="symbol"?e+"":e,o);import{d as st,c as jt,r as He,H as Qt,w as Ht,V as re,$ as _e,a4 as z,W as at,ad as Ut,ae as lt,F as Gt,ac as zt,n as Zt,u as se,D as Yt}from"./Dg7Bj1Dn.js";import{_ as Xt}from"./CA2Ut2yR.js";const Jt={class:"promotion-dialog",open:""},eo=["aria-label","onClick","onTouchstartPassive"],to=st({__name:"PromotionDialog",props:{state:{}},emits:["promotionSelected"],setup(t,{emit:e}){const o=t,n=[{name:"Queen",data:"q"},{name:"Knight",data:"n"},{name:"Rook",data:"r"},{name:"Bishop",data:"b"}];function r(i){var a,s;(s=(a=o.state).callback)==null||s.call(a,i.data),e("promotionSelected")}return(i,a)=>(re(),_e("dialog",Jt,[(re(),_e(Gt,null,zt(n,s=>z("button",{key:s.name,type:"button",class:lt([s.name.toLowerCase(),i.state.color]),"aria-label":s.name,onClick:l=>r(s),onTouchstartPassive:l=>r(s)},null,42,eo)),64))]))}});/**
 * @license
 * Copyright (c) 2023, Jeff Hlywa (jhlywa@gmail.com)
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are met:
 *
 * 1. Redistributions of source code must retain the above copyright notice,
 *    this list of conditions and the following disclaimer.
 * 2. Redistributions in binary form must reproduce the above copyright notice,
 *    this list of conditions and the following disclaimer in the documentation
 *    and/or other materials provided with the distribution.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
 * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
 * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE
 * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
 * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
 * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
 * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
 * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
 * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
 * POSSIBILITY OF SUCH DAMAGE.
 */const T="w",O="b",E="p",Ie="n",ve="b",he="r",G="q",P="k",Ce="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1",x=-1,oo={NORMAL:"n",CAPTURE:"c",BIG_PAWN:"b",EP_CAPTURE:"e",PROMOTION:"p",KSIDE_CASTLE:"k",QSIDE_CASTLE:"q"},no=["a8","b8","c8","d8","e8","f8","g8","h8","a7","b7","c7","d7","e7","f7","g7","h7","a6","b6","c6","d6","e6","f6","g6","h6","a5","b5","c5","d5","e5","f5","g5","h5","a4","b4","c4","d4","e4","f4","g4","h4","a3","b3","c3","d3","e3","f3","g3","h3","a2","b2","c2","d2","e2","f2","g2","h2","a1","b1","c1","d1","e1","f1","g1","h1"],b={NORMAL:1,CAPTURE:2,BIG_PAWN:4,EP_CAPTURE:8,PROMOTION:16,KSIDE_CASTLE:32,QSIDE_CASTLE:64},v={a8:0,b8:1,c8:2,d8:3,e8:4,f8:5,g8:6,h8:7,a7:16,b7:17,c7:18,d7:19,e7:20,f7:21,g7:22,h7:23,a6:32,b6:33,c6:34,d6:35,e6:36,f6:37,g6:38,h6:39,a5:48,b5:49,c5:50,d5:51,e5:52,f5:53,g5:54,h5:55,a4:64,b4:65,c4:66,d4:67,e4:68,f4:69,g4:70,h4:71,a3:80,b3:81,c3:82,d3:83,e3:84,f3:85,g3:86,h3:87,a2:96,b2:97,c2:98,d2:99,e2:100,f2:101,g2:102,h2:103,a1:112,b1:113,c1:114,d1:115,e1:116,f1:117,g1:118,h1:119},Ee={b:[16,32,17,15],w:[-16,-32,-17,-15]},Ue={n:[-18,-33,-31,-14,18,33,31,14],b:[-17,-15,17,15],r:[-16,1,16,-1],q:[-17,-16,-15,1,17,16,15,-1],k:[-17,-16,-15,1,17,16,15,-1]},ro=[20,0,0,0,0,0,0,24,0,0,0,0,0,0,20,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,24,24,24,24,24,24,56,0,56,24,24,24,24,24,24,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,20,0,0,0,0,0,0,24,0,0,0,0,0,0,20],io=[17,0,0,0,0,0,0,16,0,0,0,0,0,0,15,0,0,17,0,0,0,0,0,16,0,0,0,0,0,15,0,0,0,0,17,0,0,0,0,16,0,0,0,0,15,0,0,0,0,0,0,17,0,0,0,16,0,0,0,15,0,0,0,0,0,0,0,0,17,0,0,16,0,0,15,0,0,0,0,0,0,0,0,0,0,17,0,16,0,15,0,0,0,0,0,0,0,0,0,0,0,0,17,16,15,0,0,0,0,0,0,0,1,1,1,1,1,1,1,0,-1,-1,-1,-1,-1,-1,-1,0,0,0,0,0,0,0,-15,-16,-17,0,0,0,0,0,0,0,0,0,0,0,0,-15,0,-16,0,-17,0,0,0,0,0,0,0,0,0,0,-15,0,0,-16,0,0,-17,0,0,0,0,0,0,0,0,-15,0,0,0,-16,0,0,0,-17,0,0,0,0,0,0,-15,0,0,0,0,-16,0,0,0,0,-17,0,0,0,0,-15,0,0,0,0,0,-16,0,0,0,0,0,-17,0,0,-15,0,0,0,0,0,0,-16,0,0,0,0,0,0,-17],so={p:1,n:2,b:4,r:8,q:16,k:32},ao="pnbrqkPNBRQK",Ge=[Ie,ve,he,G],lo=7,co=6,ho=1,uo=0,me={[P]:b.KSIDE_CASTLE,[G]:b.QSIDE_CASTLE},Q={w:[{square:v.a1,flag:b.QSIDE_CASTLE},{square:v.h1,flag:b.KSIDE_CASTLE}],b:[{square:v.a8,flag:b.QSIDE_CASTLE},{square:v.h8,flag:b.KSIDE_CASTLE}]},po={b:ho,w:co},fo=["1-0","0-1","1/2-1/2","*"];function J(t){return t>>4}function de(t){return t&15}function ct(t){return"0123456789".indexOf(t)!==-1}function L(t){const e=de(t),o=J(t);return"abcdefgh".substring(e,e+1)+"87654321".substring(o,o+1)}function ae(t){return t===T?O:T}function go(t){const e=t.split(/\s+/);if(e.length!==6)return{ok:!1,error:"Invalid FEN: must contain six space-delimited fields"};const o=parseInt(e[5],10);if(isNaN(o)||o<=0)return{ok:!1,error:"Invalid FEN: move number must be a positive integer"};const n=parseInt(e[4],10);if(isNaN(n)||n<0)return{ok:!1,error:"Invalid FEN: half move counter number must be a non-negative integer"};if(!/^(-|[abcdefgh][36])$/.test(e[3]))return{ok:!1,error:"Invalid FEN: en-passant square is invalid"};if(/[^kKqQ-]/.test(e[2]))return{ok:!1,error:"Invalid FEN: castling availability is invalid"};if(!/^(w|b)$/.test(e[1]))return{ok:!1,error:"Invalid FEN: side-to-move is invalid"};const r=e[0].split("/");if(r.length!==8)return{ok:!1,error:"Invalid FEN: piece data does not contain 8 '/'-delimited rows"};for(let a=0;a<r.length;a++){let s=0,l=!1;for(let c=0;c<r[a].length;c++)if(ct(r[a][c])){if(l)return{ok:!1,error:"Invalid FEN: piece data is invalid (consecutive number)"};s+=parseInt(r[a][c],10),l=!0}else{if(!/^[prnbqkPRNBQK]$/.test(r[a][c]))return{ok:!1,error:"Invalid FEN: piece data is invalid (invalid piece)"};s+=1,l=!1}if(s!==8)return{ok:!1,error:"Invalid FEN: piece data is invalid (too many squares in rank)"}}if(e[3][1]=="3"&&e[1]=="w"||e[3][1]=="6"&&e[1]=="b")return{ok:!1,error:"Invalid FEN: illegal en-passant square"};const i=[{color:"white",regex:/K/g},{color:"black",regex:/k/g}];for(const{color:a,regex:s}of i){if(!s.test(e[0]))return{ok:!1,error:`Invalid FEN: missing ${a} king`};if((e[0].match(s)||[]).length>1)return{ok:!1,error:`Invalid FEN: too many ${a} kings`}}return{ok:!0}}function mo(t,e){const o=t.from,n=t.to,r=t.piece;let i=0,a=0,s=0;for(let l=0,c=e.length;l<c;l++){const u=e[l].from,p=e[l].to,h=e[l].piece;r===h&&o!==u&&n===p&&(i++,J(o)===J(u)&&a++,de(o)===de(u)&&s++)}return i>0?a>0&&s>0?L(o):s>0?L(o).charAt(1):L(o).charAt(0):""}function H(t,e,o,n,r,i=void 0,a=b.NORMAL){const s=J(n);if(r===E&&(s===lo||s===uo))for(let l=0;l<Ge.length;l++){const c=Ge[l];t.push({color:e,from:o,to:n,piece:r,captured:i,promotion:c,flags:a|b.PROMOTION})}else t.push({color:e,from:o,to:n,piece:r,captured:i,flags:a})}function ze(t){let e=t.charAt(0);return e>="a"&&e<="h"?t.match(/[a-h]\d.*[a-h]\d/)?void 0:E:(e=e.toLowerCase(),e==="o"?P:e)}function Pe(t){return t.replace(/=/,"").replace(/[+#]?[?!]*$/,"")}class bo{constructor(e=Ce){M(this,"_board",new Array(128));M(this,"_turn",T);M(this,"_header",{});M(this,"_kings",{w:x,b:x});M(this,"_epSquare",-1);M(this,"_halfMoves",0);M(this,"_moveNumber",0);M(this,"_history",[]);M(this,"_comments",{});M(this,"_castling",{w:0,b:0});this.load(e)}clear(e=!1){this._board=new Array(128),this._kings={w:x,b:x},this._turn=T,this._castling={w:0,b:0},this._epSquare=x,this._halfMoves=0,this._moveNumber=1,this._history=[],this._comments={},this._header=e?this._header:{},this._updateSetup(this.fen())}removeHeader(e){e in this._header&&delete this._header[e]}load(e,o=!1){let n=e.split(/\s+/);if(n.length>=2&&n.length<6){const l=["-","-","0","1"];e=n.concat(l.slice(-(6-n.length))).join(" ")}n=e.split(/\s+/);const{ok:r,error:i}=go(e);if(!r)throw new Error(i);const a=n[0];let s=0;this.clear(o);for(let l=0;l<a.length;l++){const c=a.charAt(l);if(c==="/")s+=8;else if(ct(c))s+=parseInt(c,10);else{const u=c<"a"?T:O;this.put({type:c.toLowerCase(),color:u},L(s)),s++}}this._turn=n[1],n[2].indexOf("K")>-1&&(this._castling.w|=b.KSIDE_CASTLE),n[2].indexOf("Q")>-1&&(this._castling.w|=b.QSIDE_CASTLE),n[2].indexOf("k")>-1&&(this._castling.b|=b.KSIDE_CASTLE),n[2].indexOf("q")>-1&&(this._castling.b|=b.QSIDE_CASTLE),this._epSquare=n[3]==="-"?x:v[n[3]],this._halfMoves=parseInt(n[4],10),this._moveNumber=parseInt(n[5],10),this._updateSetup(this.fen())}fen(){var i,a;let e=0,o="";for(let s=v.a8;s<=v.h1;s++){if(this._board[s]){e>0&&(o+=e,e=0);const{color:l,type:c}=this._board[s];o+=l===T?c.toUpperCase():c.toLowerCase()}else e++;s+1&136&&(e>0&&(o+=e),s!==v.h1&&(o+="/"),e=0,s+=8)}let n="";this._castling[T]&b.KSIDE_CASTLE&&(n+="K"),this._castling[T]&b.QSIDE_CASTLE&&(n+="Q"),this._castling[O]&b.KSIDE_CASTLE&&(n+="k"),this._castling[O]&b.QSIDE_CASTLE&&(n+="q"),n=n||"-";let r="-";if(this._epSquare!==x){const s=this._epSquare+(this._turn===T?16:-16),l=[s+1,s-1];for(const c of l){if(c&136)continue;const u=this._turn;if(((i=this._board[c])==null?void 0:i.color)===u&&((a=this._board[c])==null?void 0:a.type)===E){this._makeMove({color:u,from:c,to:this._epSquare,piece:E,captured:E,flags:b.EP_CAPTURE});const p=!this._isKingAttacked(u);if(this._undoMove(),p){r=L(this._epSquare);break}}}}return[o,this._turn,n,r,this._halfMoves,this._moveNumber].join(" ")}_updateSetup(e){this._history.length>0||(e!==Ce?(this._header.SetUp="1",this._header.FEN=e):(delete this._header.SetUp,delete this._header.FEN))}reset(){this.load(Ce)}get(e){return this._board[v[e]]||!1}put({type:e,color:o},n){if(ao.indexOf(e.toLowerCase())===-1||!(n in v))return!1;const r=v[n];return e==P&&!(this._kings[o]==x||this._kings[o]==r)?!1:(this._board[r]={type:e,color:o},e===P&&(this._kings[o]=r),this._updateCastlingRights(),this._updateEnPassantSquare(),this._updateSetup(this.fen()),!0)}remove(e){const o=this.get(e);return delete this._board[v[e]],o&&o.type===P&&(this._kings[o.color]=x),this._updateCastlingRights(),this._updateEnPassantSquare(),this._updateSetup(this.fen()),o}_updateCastlingRights(){var n,r,i,a,s,l,c,u,p,h,m,d;const e=((n=this._board[v.e1])==null?void 0:n.type)===P&&((r=this._board[v.e1])==null?void 0:r.color)===T,o=((i=this._board[v.e8])==null?void 0:i.type)===P&&((a=this._board[v.e8])==null?void 0:a.color)===O;(!e||((s=this._board[v.a1])==null?void 0:s.type)!==he||((l=this._board[v.a1])==null?void 0:l.color)!==T)&&(this._castling.w&=~b.QSIDE_CASTLE),(!e||((c=this._board[v.h1])==null?void 0:c.type)!==he||((u=this._board[v.h1])==null?void 0:u.color)!==T)&&(this._castling.w&=~b.KSIDE_CASTLE),(!o||((p=this._board[v.a8])==null?void 0:p.type)!==he||((h=this._board[v.a8])==null?void 0:h.color)!==O)&&(this._castling.b&=~b.QSIDE_CASTLE),(!o||((m=this._board[v.h8])==null?void 0:m.type)!==he||((d=this._board[v.h8])==null?void 0:d.color)!==O)&&(this._castling.b&=~b.KSIDE_CASTLE)}_updateEnPassantSquare(){var i,a;if(this._epSquare===x)return;const e=this._epSquare+(this._turn===T?-16:16),o=this._epSquare+(this._turn===T?16:-16),n=[o+1,o-1];if(this._board[e]!==null||this._board[this._epSquare]!==null||((i=this._board[o])==null?void 0:i.color)!==ae(this._turn)||((a=this._board[o])==null?void 0:a.type)!==E){this._epSquare=x;return}const r=s=>{var l,c;return!(s&136)&&((l=this._board[s])==null?void 0:l.color)===this._turn&&((c=this._board[s])==null?void 0:c.type)===E};n.some(r)||(this._epSquare=x)}_attacked(e,o){for(let n=v.a8;n<=v.h1;n++){if(n&136){n+=7;continue}if(this._board[n]===void 0||this._board[n].color!==e)continue;const r=this._board[n],i=n-o;if(i===0)continue;const a=i+119;if(ro[a]&so[r.type]){if(r.type===E){if(i>0){if(r.color===T)return!0}else if(r.color===O)return!0;continue}if(r.type==="n"||r.type==="k")return!0;const s=io[a];let l=n+s,c=!1;for(;l!==o;){if(this._board[l]!=null){c=!0;break}l+=s}if(!c)return!0}}return!1}_isKingAttacked(e){const o=this._kings[e];return o===-1?!1:this._attacked(ae(e),o)}isAttacked(e,o){return this._attacked(o,v[e])}isCheck(){return this._isKingAttacked(this._turn)}inCheck(){return this.isCheck()}isCheckmate(){return this.isCheck()&&this._moves().length===0}isStalemate(){return!this.isCheck()&&this._moves().length===0}isInsufficientMaterial(){const e={b:0,n:0,r:0,q:0,k:0,p:0},o=[];let n=0,r=0;for(let i=v.a8;i<=v.h1;i++){if(r=(r+1)%2,i&136){i+=7;continue}const a=this._board[i];a&&(e[a.type]=a.type in e?e[a.type]+1:1,a.type===ve&&o.push(r),n++)}if(n===2||n===3&&(e[ve]===1||e[Ie]===1))return!0;if(n===e[ve]+2){let i=0;const a=o.length;for(let s=0;s<a;s++)i+=o[s];if(i===0||i===a)return!0}return!1}isThreefoldRepetition(){const e=[],o={};let n=!1;for(;;){const r=this._undoMove();if(!r)break;e.push(r)}for(;;){const r=this.fen().split(" ").slice(0,4).join(" ");o[r]=r in o?o[r]+1:1,o[r]>=3&&(n=!0);const i=e.pop();if(i)this._makeMove(i);else break}return n}isDraw(){return this._halfMoves>=100||this.isStalemate()||this.isInsufficientMaterial()||this.isThreefoldRepetition()}isGameOver(){return this.isCheckmate()||this.isStalemate()||this.isDraw()}moves({verbose:e=!1,square:o=void 0,piece:n=void 0}={}){const r=this._moves({square:o,piece:n});return e?r.map(i=>this._makePretty(i)):r.map(i=>this._moveToSan(i,r))}_moves({legal:e=!0,piece:o=void 0,square:n=void 0}={}){var m;const r=n?n.toLowerCase():void 0,i=o==null?void 0:o.toLowerCase(),a=[],s=this._turn,l=ae(s);let c=v.a8,u=v.h1,p=!1;if(r)if(r in v)c=u=v[r],p=!0;else return[];for(let d=c;d<=u;d++){if(d&136){d+=7;continue}if(!this._board[d]||this._board[d].color===l)continue;const{type:f}=this._board[d];let _;if(f===E){if(i&&i!==f)continue;_=d+Ee[s][0],this._board[_]||(H(a,s,d,_,E),_=d+Ee[s][1],po[s]===J(d)&&!this._board[_]&&H(a,s,d,_,E,void 0,b.BIG_PAWN));for(let y=2;y<4;y++)_=d+Ee[s][y],!(_&136)&&(((m=this._board[_])==null?void 0:m.color)===l?H(a,s,d,_,E,this._board[_].type,b.CAPTURE):_===this._epSquare&&H(a,s,d,_,E,E,b.EP_CAPTURE))}else{if(i&&i!==f)continue;for(let y=0,g=Ue[f].length;y<g;y++){const S=Ue[f][y];for(_=d;_+=S,!(_&136);){if(!this._board[_])H(a,s,d,_,f);else{if(this._board[_].color===s)break;H(a,s,d,_,f,this._board[_].type,b.CAPTURE);break}if(f===Ie||f===P)break}}}}if((i===void 0||i===P)&&(!p||u===this._kings[s])){if(this._castling[s]&b.KSIDE_CASTLE){const d=this._kings[s],f=d+2;!this._board[d+1]&&!this._board[f]&&!this._attacked(l,this._kings[s])&&!this._attacked(l,d+1)&&!this._attacked(l,f)&&H(a,s,this._kings[s],f,P,void 0,b.KSIDE_CASTLE)}if(this._castling[s]&b.QSIDE_CASTLE){const d=this._kings[s],f=d-2;!this._board[d-1]&&!this._board[d-2]&&!this._board[d-3]&&!this._attacked(l,this._kings[s])&&!this._attacked(l,d-1)&&!this._attacked(l,f)&&H(a,s,this._kings[s],f,P,void 0,b.QSIDE_CASTLE)}}if(!e||this._kings[s]===-1)return a;const h=[];for(let d=0,f=a.length;d<f;d++)this._makeMove(a[d]),this._isKingAttacked(s)||h.push(a[d]),this._undoMove();return h}move(e,{strict:o=!1}={}){let n=null;if(typeof e=="string")n=this._moveFromSan(e,o);else if(typeof e=="object"){const i=this._moves();for(let a=0,s=i.length;a<s;a++)if(e.from===L(i[a].from)&&e.to===L(i[a].to)&&(!("promotion"in i[a])||e.promotion===i[a].promotion)){n=i[a];break}}if(!n)throw typeof e=="string"?new Error(`Invalid move: ${e}`):new Error(`Invalid move: ${JSON.stringify(e)}`);const r=this._makePretty(n);return this._makeMove(n),r}_push(e){this._history.push({move:e,kings:{b:this._kings.b,w:this._kings.w},turn:this._turn,castling:{b:this._castling.b,w:this._castling.w},epSquare:this._epSquare,halfMoves:this._halfMoves,moveNumber:this._moveNumber})}_makeMove(e){const o=this._turn,n=ae(o);if(this._push(e),this._board[e.to]=this._board[e.from],delete this._board[e.from],e.flags&b.EP_CAPTURE&&(this._turn===O?delete this._board[e.to-16]:delete this._board[e.to+16]),e.promotion&&(this._board[e.to]={type:e.promotion,color:o}),this._board[e.to].type===P){if(this._kings[o]=e.to,e.flags&b.KSIDE_CASTLE){const r=e.to-1,i=e.to+1;this._board[r]=this._board[i],delete this._board[i]}else if(e.flags&b.QSIDE_CASTLE){const r=e.to+1,i=e.to-2;this._board[r]=this._board[i],delete this._board[i]}this._castling[o]=0}if(this._castling[o]){for(let r=0,i=Q[o].length;r<i;r++)if(e.from===Q[o][r].square&&this._castling[o]&Q[o][r].flag){this._castling[o]^=Q[o][r].flag;break}}if(this._castling[n]){for(let r=0,i=Q[n].length;r<i;r++)if(e.to===Q[n][r].square&&this._castling[n]&Q[n][r].flag){this._castling[n]^=Q[n][r].flag;break}}e.flags&b.BIG_PAWN?o===O?this._epSquare=e.to-16:this._epSquare=e.to+16:this._epSquare=x,e.piece===E?this._halfMoves=0:e.flags&(b.CAPTURE|b.EP_CAPTURE)?this._halfMoves=0:this._halfMoves++,o===O&&this._moveNumber++,this._turn=n}undo(){const e=this._undoMove();return e?this._makePretty(e):null}_undoMove(){const e=this._history.pop();if(e===void 0)return null;const o=e.move;this._kings=e.kings,this._turn=e.turn,this._castling=e.castling,this._epSquare=e.epSquare,this._halfMoves=e.halfMoves,this._moveNumber=e.moveNumber;const n=this._turn,r=ae(n);if(this._board[o.from]=this._board[o.to],this._board[o.from].type=o.piece,delete this._board[o.to],o.captured)if(o.flags&b.EP_CAPTURE){let i;n===O?i=o.to-16:i=o.to+16,this._board[i]={type:E,color:r}}else this._board[o.to]={type:o.captured,color:r};if(o.flags&(b.KSIDE_CASTLE|b.QSIDE_CASTLE)){let i,a;o.flags&b.KSIDE_CASTLE?(i=o.to+1,a=o.to-1):(i=o.to-2,a=o.to+1),this._board[i]=this._board[a],delete this._board[a]}return o}pgn({newline:e=`
`,maxWidth:o=0}={}){const n=[];let r=!1;for(const h in this._header)n.push("["+h+' "'+this._header[h]+'"]'+e),r=!0;r&&this._history.length&&n.push(e);const i=h=>{const m=this._comments[this.fen()];if(typeof m<"u"){const d=h.length>0?" ":"";h=`${h}${d}{${m}}`}return h},a=[];for(;this._history.length>0;)a.push(this._undoMove());const s=[];let l="";for(a.length===0&&s.push(i(""));a.length>0;){l=i(l);const h=a.pop();if(!h)break;if(!this._history.length&&h.color==="b"){const m=`${this._moveNumber}. ...`;l=l?`${l} ${m}`:m}else h.color==="w"&&(l.length&&s.push(l),l=this._moveNumber+".");l=l+" "+this._moveToSan(h,this._moves({legal:!0})),this._makeMove(h)}if(l.length&&s.push(i(l)),typeof this._header.Result<"u"&&s.push(this._header.Result),o===0)return n.join("")+s.join(" ");const c=function(){return n.length>0&&n[n.length-1]===" "?(n.pop(),!0):!1},u=function(h,m){for(const d of m.split(" "))if(d){if(h+d.length>o){for(;c();)h--;n.push(e),h=0}n.push(d),h+=d.length,n.push(" "),h++}return c()&&h--,h};let p=0;for(let h=0;h<s.length;h++){if(p+s[h].length>o&&s[h].includes("{")){p=u(p,s[h]);continue}p+s[h].length>o&&h!==0?(n[n.length-1]===" "&&n.pop(),n.push(e),p=0):h!==0&&(n.push(" "),p++),n.push(s[h]),p+=s[h].length}return n.join("")}header(...e){for(let o=0;o<e.length;o+=2)typeof e[o]=="string"&&typeof e[o+1]=="string"&&(this._header[e[o]]=e[o+1]);return this._header}loadPgn(e,{strict:o=!1,newlineChar:n=`\r?
`}={}){function r(g){return g.replace(/\\/g,"\\")}function i(g){const S={},D=g.split(new RegExp(r(n)));let I="",ne="";for(let F=0;F<D.length;F++){const w=/^\s*\[\s*([A-Za-z]+)\s*"(.*)"\s*\]\s*$/;I=D[F].replace(w,"$1"),ne=D[F].replace(w,"$2"),I.trim().length>0&&(S[I]=ne)}return S}e=e.trim();const a=new RegExp("^(\\[((?:"+r(n)+")|.)*\\])((?:\\s*"+r(n)+"){2}|(?:\\s*"+r(n)+")*$)").exec(e),s=a&&a.length>=2?a[1]:"";this.reset();const l=i(s);let c="";for(const g in l)g.toLowerCase()==="fen"&&(c=l[g]),this.header(g,l[g]);if(!o)c&&this.load(c,!0);else if(l.SetUp==="1"){if(!("FEN"in l))throw new Error("Invalid PGN: FEN tag must be supplied with SetUp tag");this.load(l.FEN,!0)}function u(g){return Array.from(g).map(function(S){return S.charCodeAt(0)<128?S.charCodeAt(0).toString(16):encodeURIComponent(S).replace(/%/g,"").toLowerCase()}).join("")}function p(g){return g.length==0?"":decodeURIComponent("%"+(g.match(/.{1,2}/g)||[]).join("%"))}const h=function(g){return g=g.replace(new RegExp(r(n),"g")," "),`{${u(g.slice(1,g.length-1))}}`},m=function(g){if(g.startsWith("{")&&g.endsWith("}"))return p(g.slice(1,g.length-1))};let d=e.replace(s,"").replace(new RegExp(`({[^}]*})+?|;([^${r(n)}]*)`,"g"),function(g,S,D){return S!==void 0?h(S):" "+h(`{${D.slice(1)}}`)}).replace(new RegExp(r(n),"g")," ");const f=/(\([^()]+\))+?/g;for(;f.test(d);)d=d.replace(f,"");d=d.replace(/\d+\.(\.\.)?/g,""),d=d.replace(/\.\.\./g,""),d=d.replace(/\$\d+/g,"");let _=d.trim().split(new RegExp(/\s+/));_=_.filter(g=>g!=="");let y="";for(let g=0;g<_.length;g++){const S=m(_[g]);if(S!==void 0){this._comments[this.fen()]=S;continue}const D=this._moveFromSan(_[g],o);if(D==null)if(fo.indexOf(_[g])>-1)y=_[g];else throw new Error(`Invalid move in PGN: ${_[g]}`);else y="",this._makeMove(D)}y&&Object.keys(this._header).length&&!this._header.Result&&this.header("Result",y)}_moveToSan(e,o){let n="";if(e.flags&b.KSIDE_CASTLE)n="O-O";else if(e.flags&b.QSIDE_CASTLE)n="O-O-O";else{if(e.piece!==E){const r=mo(e,o);n+=e.piece.toUpperCase()+r}e.flags&(b.CAPTURE|b.EP_CAPTURE)&&(e.piece===E&&(n+=L(e.from)[0]),n+="x"),n+=L(e.to),e.promotion&&(n+="="+e.promotion.toUpperCase())}return this._makeMove(e),this.isCheck()&&(this.isCheckmate()?n+="#":n+="+"),this._undoMove(),n}_moveFromSan(e,o=!1){const n=Pe(e);let r=ze(n),i=this._moves({legal:!0,piece:r});for(let h=0,m=i.length;h<m;h++)if(n===Pe(this._moveToSan(i[h],i)))return i[h];if(o)return null;let a,s,l,c,u,p=!1;if(s=n.match(/([pnbrqkPNBRQK])?([a-h][1-8])x?-?([a-h][1-8])([qrbnQRBN])?/),s?(a=s[1],l=s[2],c=s[3],u=s[4],l.length==1&&(p=!0)):(s=n.match(/([pnbrqkPNBRQK])?([a-h]?[1-8]?)x?-?([a-h][1-8])([qrbnQRBN])?/),s&&(a=s[1],l=s[2],c=s[3],u=s[4],l.length==1&&(p=!0))),r=ze(n),i=this._moves({legal:!0,piece:a||r}),!c)return null;for(let h=0,m=i.length;h<m;h++)if(l){if((!a||a.toLowerCase()==i[h].piece)&&v[l]==i[h].from&&v[c]==i[h].to&&(!u||u.toLowerCase()==i[h].promotion))return i[h];if(p){const d=L(i[h].from);if((!a||a.toLowerCase()==i[h].piece)&&v[c]==i[h].to&&(l==d[0]||l==d[1])&&(!u||u.toLowerCase()==i[h].promotion))return i[h]}}else if(n===Pe(this._moveToSan(i[h],i)).replace("x",""))return i[h];return null}ascii(){let e=`   +------------------------+
`;for(let o=v.a8;o<=v.h1;o++){if(de(o)===0&&(e+=" "+"87654321"[J(o)]+" |"),this._board[o]){const n=this._board[o].type,r=this._board[o].color===T?n.toUpperCase():n.toLowerCase();e+=" "+r+" "}else e+=" . ";o+1&136&&(e+=`|
`,o+=8)}return e+=`   +------------------------+
`,e+="     a  b  c  d  e  f  g  h",e}perft(e){const o=this._moves({legal:!1});let n=0;const r=this._turn;for(let i=0,a=o.length;i<a;i++)this._makeMove(o[i]),this._isKingAttacked(r)||(e-1>0?n+=this.perft(e-1):n++),this._undoMove();return n}_makePretty(e){const{color:o,piece:n,from:r,to:i,flags:a,captured:s,promotion:l}=e;let c="";for(const m in b)b[m]&a&&(c+=oo[m]);const u=L(r),p=L(i),h={color:o,piece:n,from:u,to:p,san:this._moveToSan(e,this._moves({legal:!0})),flags:c,lan:u+p,before:this.fen(),after:""};return this._makeMove(e),h.after=this.fen(),this._undoMove(),s&&(h.captured=s),l&&(h.promotion=l,h.lan+=l),h}turn(){return this._turn}board(){const e=[];let o=[];for(let n=v.a8;n<=v.h1;n++)this._board[n]==null?o.push(null):o.push({square:L(n),type:this._board[n].type,color:this._board[n].color}),n+1&136&&(e.push(o),o=[],n+=8);return e}squareColor(e){if(e in v){const o=v[e];return(J(o)+de(o))%2===0?"light":"dark"}return null}history({verbose:e=!1}={}){const o=[],n=[];for(;this._history.length>0;)o.push(this._undoMove());for(;;){const r=o.pop();if(!r)break;e?n.push(this._makePretty(r)):n.push(this._moveToSan(r,this._moves())),this._makeMove(r)}return n}_pruneComments(){const e=[],o={},n=r=>{r in this._comments&&(o[r]=this._comments[r])};for(;this._history.length>0;)e.push(this._undoMove());for(n(this.fen());;){const r=e.pop();if(!r)break;this._makeMove(r),n(this.fen())}this._comments=o}getComment(){return this._comments[this.fen()]}setComment(e){this._comments[this.fen()]=e.replace("{","[").replace("}","]")}deleteComment(){const e=this._comments[this.fen()];return delete this._comments[this.fen()],e}getComments(){return this._pruneComments(),Object.keys(this._comments).map(e=>({fen:e,comment:this._comments[e]}))}deleteComments(){return this._pruneComments(),Object.keys(this._comments).map(e=>{const o=this._comments[e];return delete this._comments[e],{fen:e,comment:o}})}setCastlingRights(e,o){for(const r of[P,G])o[r]!==void 0&&(o[r]?this._castling[e]|=me[r]:this._castling[e]&=~me[r]);this._updateCastlingRights();const n=this.getCastlingRights(e);return(o[P]===void 0||o[P]===n[P])&&(o[G]===void 0||o[G]===n[G])}getCastlingRights(e){return{[P]:(this._castling[e]&me[P])!==0,[G]:(this._castling[e]&me[G])!==0}}moveNumber(){return this._moveNumber}}function vo(t){const e=[];for(const o of t)e.push({orig:o.to,brush:"yellow"}),o.captured&&e.push({orig:o.from,dest:o.to,brush:"red"}),o.san.includes("+")&&e.push({orig:o.from,dest:o.to,brush:"blue"});return e}function be(t){return t==="w"?"white":"black"}function Ze(t){const e=new Map;for(const o of no){const n=t.moves({square:o,verbose:!0});n.length&&e.set(n[0].from,n.map(r=>r.to))}return e}function _o(t,e){if((e==null?void 0:e.type)!=="p")return!1;const o=(e==null?void 0:e.color)==="w"?"8":"1";return t[1]===o}function ue(t){return!!t&&t instanceof Object&&!(t instanceof Array)&&!(t instanceof Function)}function we(t){return ue(t)?Object.fromEntries(Object.entries(t).map(([e,o])=>[e,we(o)])):t}function ht(t,e){const o={...t,...e};for(const n in o)o[n]=ue(t==null?void 0:t[n])&&ue(e==null?void 0:e[n])?ht(t[n],e[n]):we(o[n]);return o}function dt(t,e){const o={};for(const n in e)if(ue(t==null?void 0:t[n])&&ue(e==null?void 0:e[n])){const r=dt(t[n],e[n]);Object.keys(r).length>0&&(o[n]=r)}else(t==null?void 0:t[n])!==e[n]&&(o[n]=e[n]);return o}const wo={p:"pawn",n:"knight",b:"bishop",r:"rook",q:"queen",k:"king"},yo=new Map([["b1",["a3","c3"]],["g1",["f3","h3"]],["a2",["a3","a4"]],["b2",["b3","b4"]],["c2",["c3","c4"]],["d2",["d3","d4"]],["e2",["e3","e4"]],["f2",["f3","f4"]],["g2",["g3","g4"]],["h2",["h3","h4"]]]),ko="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1",So={fen:ko,orientation:"white",turnColor:"white",coordinates:!1,autoCastle:!0,viewOnly:!1,disableContextMenu:!1,addPieceZIndex:!1,blockTouchScroll:!1,highlight:{lastMove:!0,check:!0},animation:{enabled:!0,duration:300},lastMove:void 0,movable:{free:!1,color:"white",showDests:!0,dests:yo,events:{after:()=>{},afterNewPiece:void 0},rookCastle:!0},premovable:{enabled:!0,showDests:!0,castle:!0,events:{set:void 0,unset:void 0}},predroppable:{enabled:!1,events:{set:void 0,unset:void 0}},draggable:{enabled:!0,distance:3,autoDistance:!0,showGhost:!0,deleteOnDropOff:!1},selectable:{enabled:!0},events:{change:void 0,move:void 0,dropNewPiece:void 0,select:void 0,insert:void 0},drawable:{enabled:!0,visible:!0,defaultSnapToValidMove:!0,eraseOnClick:!0,shapes:[],autoShapes:[],brushes:{green:{key:"g",color:"#15781B",opacity:1,lineWidth:10},red:{key:"r",color:"#882020",opacity:1,lineWidth:10},blue:{key:"b",color:"#003088",opacity:1,lineWidth:10},yellow:{key:"y",color:"#e68f00",opacity:1,lineWidth:10},paleBlue:{key:"pb",color:"#003088",opacity:.4,lineWidth:15},paleGreen:{key:"pg",color:"#15781B",opacity:.4,lineWidth:15},paleRed:{key:"pr",color:"#882020",opacity:.4,lineWidth:15},paleGrey:{key:"pgr",color:"#4a4a4a",opacity:.35,lineWidth:15}}}},Co=["white","black"],De=["a","b","c","d","e","f","g","h"],Oe=["1","2","3","4","5","6","7","8"],Eo=[...Oe].reverse(),Re=Array.prototype.concat(...De.map(t=>Oe.map(e=>t+e))),R=t=>Re[8*t[0]+t[1]],k=t=>[t.charCodeAt(0)-97,t.charCodeAt(1)-49],ut=Re.map(k);function Po(t){let e;const o=()=>(e===void 0&&(e=t()),e);return o.clear=()=>{e=void 0},o}const Mo=()=>{let t;return{start(){t=performance.now()},cancel(){t=void 0},stop(){if(!t)return 0;const e=performance.now()-t;return t=void 0,e}}},Ke=t=>t==="white"?"black":"white",pe=(t,e)=>{const o=t[0]-e[0],n=t[1]-e[1];return o*o+n*n},Ne=(t,e)=>t.role===e.role&&t.color===e.color,fe=t=>(e,o)=>[(o?e[0]:7-e[0])*t.width/8,(o?7-e[1]:e[1])*t.height/8],V=(t,e)=>{t.style.transform=`translate(${e[0]}px,${e[1]}px)`},pt=(t,e,o=1)=>{t.style.transform=`translate(${e[0]}px,${e[1]}px) scale(${o})`},$e=(t,e)=>{t.style.visibility=e?"visible":"hidden"},te=t=>{var e;if(t.clientX||t.clientX===0)return[t.clientX,t.clientY];if(!((e=t.targetTouches)===null||e===void 0)&&e[0])return[t.targetTouches[0].clientX,t.targetTouches[0].clientY]},ft=t=>t.buttons===2||t.button===2,j=(t,e)=>{const o=document.createElement(t);return e&&(o.className=e),o};function gt(t,e,o){const n=k(t);return e||(n[0]=7-n[0],n[1]=7-n[1]),[o.left+o.width*n[0]/8+o.width/16,o.top+o.height*(7-n[1])/8+o.height/16]}const ee=(t,e)=>Math.abs(t-e),To=t=>(e,o,n,r)=>ee(e,n)<2&&(t==="white"?r===o+1||o<=1&&r===o+2&&e===n:r===o-1||o>=6&&r===o-2&&e===n),mt=(t,e,o,n)=>{const r=ee(t,o),i=ee(e,n);return r===1&&i===2||r===2&&i===1},bt=(t,e,o,n)=>ee(t,o)===ee(e,n),vt=(t,e,o,n)=>t===o||e===n,_t=(t,e,o,n)=>bt(t,e,o,n)||vt(t,e,o,n),Ao=(t,e,o)=>(n,r,i,a)=>ee(n,i)<2&&ee(r,a)<2||o&&r===a&&r===(t==="white"?0:7)&&(n===4&&(i===2&&e.includes(0)||i===6&&e.includes(7))||e.includes(i));function Io(t,e){const o=e==="white"?"1":"8",n=[];for(const[r,i]of t)r[1]===o&&i.color===e&&i.role==="rook"&&n.push(k(r)[0]);return n}function wt(t,e,o){const n=t.get(e);if(!n)return[];const r=k(e),i=n.role,a=i==="pawn"?To(n.color):i==="knight"?mt:i==="bishop"?bt:i==="rook"?vt:i==="queen"?_t:Ao(n.color,Io(t,n.color),o);return ut.filter(s=>(r[0]!==s[0]||r[1]!==s[1])&&a(r[0],r[1],s[0],s[1])).map(R)}function N(t,...e){t&&setTimeout(()=>t(...e),1)}function No(t){t.orientation=Ke(t.orientation),t.animation.current=t.draggable.current=t.selected=void 0}function qo(t,e){for(const[o,n]of e)n?t.pieces.set(o,n):t.pieces.delete(o)}function xo(t,e){if(t.check=void 0,e===!0&&(e=t.turnColor),e)for(const[o,n]of t.pieces)n.role==="king"&&n.color===e&&(t.check=o)}function Lo(t,e,o,n){Y(t),t.premovable.current=[e,o],N(t.premovable.events.set,e,o,n)}function Z(t){t.premovable.current&&(t.premovable.current=void 0,N(t.premovable.events.unset))}function Do(t,e,o){Z(t),t.predroppable.current={role:e,key:o},N(t.predroppable.events.set,e,o)}function Y(t){const e=t.predroppable;e.current&&(e.current=void 0,N(e.events.unset))}function Oo(t,e,o){if(!t.autoCastle)return!1;const n=t.pieces.get(e);if(!n||n.role!=="king")return!1;const r=k(e),i=k(o);if(r[1]!==0&&r[1]!==7||r[1]!==i[1])return!1;r[0]===4&&!t.pieces.has(o)&&(i[0]===6?o=R([7,i[1]]):i[0]===2&&(o=R([0,i[1]])));const a=t.pieces.get(o);return!a||a.color!==n.color||a.role!=="rook"?!1:(t.pieces.delete(e),t.pieces.delete(o),r[0]<i[0]?(t.pieces.set(R([6,i[1]]),n),t.pieces.set(R([5,i[1]]),a)):(t.pieces.set(R([2,i[1]]),n),t.pieces.set(R([3,i[1]]),a)),!0)}function yt(t,e,o){const n=t.pieces.get(e),r=t.pieces.get(o);if(e===o||!n)return!1;const i=r&&r.color!==n.color?r:void 0;return o===t.selected&&K(t),N(t.events.move,e,o,i),Oo(t,e,o)||(t.pieces.set(o,n),t.pieces.delete(e)),t.lastMove=[e,o],t.check=void 0,N(t.events.change),i||!0}function Be(t,e,o,n){if(t.pieces.has(o))if(n)t.pieces.delete(o);else return!1;return N(t.events.dropNewPiece,e,o),t.pieces.set(o,e),t.lastMove=[o],t.check=void 0,N(t.events.change),t.movable.dests=void 0,t.turnColor=Ke(t.turnColor),!0}function kt(t,e,o){const n=yt(t,e,o);return n&&(t.movable.dests=void 0,t.turnColor=Ke(t.turnColor),t.animation.current=void 0),n}function St(t,e,o){if(Ve(t,e,o)){const n=kt(t,e,o);if(n){const r=t.hold.stop();K(t);const i={premove:!1,ctrlKey:t.stats.ctrlKey,holdTime:r};return n!==!0&&(i.captured=n),N(t.movable.events.after,e,o,i),!0}}else if(Ko(t,e,o))return Lo(t,e,o,{ctrlKey:t.stats.ctrlKey}),K(t),!0;return K(t),!1}function Ct(t,e,o,n){const r=t.pieces.get(e);r&&(Ro(t,e,o)||n)?(t.pieces.delete(e),Be(t,r,o,n),N(t.movable.events.afterNewPiece,r.role,o,{premove:!1,predrop:!1})):r&&$o(t,e,o)?Do(t,r.role,o):(Z(t),Y(t)),t.pieces.delete(e),K(t)}function qe(t,e,o){if(N(t.events.select,e),t.selected){if(t.selected===e&&!t.draggable.enabled){K(t),t.hold.cancel();return}else if((t.selectable.enabled||o)&&t.selected!==e&&St(t,t.selected,e)){t.stats.dragged=!1;return}}(t.selectable.enabled||t.draggable.enabled)&&(Pt(t,e)||Fe(t,e))&&(Et(t,e),t.hold.start())}function Et(t,e){t.selected=e,Fe(t,e)?t.premovable.customDests||(t.premovable.dests=wt(t.pieces,e,t.premovable.castle)):t.premovable.dests=void 0}function K(t){t.selected=void 0,t.premovable.dests=void 0,t.hold.cancel()}function Pt(t,e){const o=t.pieces.get(e);return!!o&&(t.movable.color==="both"||t.movable.color===o.color&&t.turnColor===o.color)}const Ve=(t,e,o)=>{var n,r;return e!==o&&Pt(t,e)&&(t.movable.free||!!(!((r=(n=t.movable.dests)===null||n===void 0?void 0:n.get(e))===null||r===void 0)&&r.includes(o)))};function Ro(t,e,o){const n=t.pieces.get(e);return!!n&&(e===o||!t.pieces.has(o))&&(t.movable.color==="both"||t.movable.color===n.color&&t.turnColor===n.color)}function Fe(t,e){const o=t.pieces.get(e);return!!o&&t.premovable.enabled&&t.movable.color===o.color&&t.turnColor!==o.color}function Ko(t,e,o){var n,r;const i=(r=(n=t.premovable.customDests)===null||n===void 0?void 0:n.get(e))!==null&&r!==void 0?r:wt(t.pieces,e,t.premovable.castle);return e!==o&&Fe(t,e)&&i.includes(o)}function $o(t,e,o){const n=t.pieces.get(e),r=t.pieces.get(o);return!!n&&(!r||r.color!==t.movable.color)&&t.predroppable.enabled&&(n.role!=="pawn"||o[1]!=="1"&&o[1]!=="8")&&t.movable.color===n.color&&t.turnColor!==n.color}function Bo(t,e){const o=t.pieces.get(e);return!!o&&t.draggable.enabled&&(t.movable.color==="both"||t.movable.color===o.color&&(t.turnColor===o.color||t.premovable.enabled))}function Vo(t){const e=t.premovable.current;if(!e)return!1;const o=e[0],n=e[1];let r=!1;if(Ve(t,o,n)){const i=kt(t,o,n);if(i){const a={premove:!0};i!==!0&&(a.captured=i),N(t.movable.events.after,o,n,a),r=!0}}return Z(t),r}function Fo(t,e){const o=t.predroppable.current;let n=!1;if(!o)return!1;if(e(o)){const r={role:o.role,color:t.movable.color};Be(t,r,o.key)&&(N(t.movable.events.afterNewPiece,o.role,o.key,{premove:!1,predrop:!0}),n=!0)}return Y(t),n}function We(t){Z(t),Y(t),K(t)}function Ye(t){t.movable.color=t.movable.dests=t.animation.current=void 0,We(t)}function oe(t,e,o){let n=Math.floor(8*(t[0]-o.left)/o.width);e||(n=7-n);let r=7-Math.floor(8*(t[1]-o.top)/o.height);return e||(r=7-r),n>=0&&n<8&&r>=0&&r<8?R([n,r]):void 0}function Wo(t,e,o,n){const r=k(t),i=ut.filter(l=>_t(r[0],r[1],l[0],l[1])||mt(r[0],r[1],l[0],l[1])),a=i.map(l=>gt(R(l),o,n)).map(l=>pe(e,l)),[,s]=a.reduce((l,c,u)=>l[0]<c?l:[c,u],[a[0],0]);return R(i[s])}const q=t=>t.orientation==="white",Mt="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR",jo={p:"pawn",r:"rook",n:"knight",b:"bishop",q:"queen",k:"king"},Qo={pawn:"p",rook:"r",knight:"n",bishop:"b",queen:"q",king:"k"};function Tt(t){t==="start"&&(t=Mt);const e=new Map;let o=7,n=0;for(const r of t)switch(r){case" ":case"[":return e;case"/":if(--o,o<0)return e;n=0;break;case"~":{const i=e.get(R([n-1,o]));i&&(i.promoted=!0);break}default:{const i=r.charCodeAt(0);if(i<57)n+=i-48;else{const a=r.toLowerCase();e.set(R([n,o]),{role:jo[a],color:r===a?"black":"white"}),++n}}}return e}function Ho(t){return Eo.map(e=>De.map(o=>{const n=t.get(o+e);if(n){let r=Qo[n.role];return n.color==="white"&&(r=r.toUpperCase()),n.promoted&&(r+="~"),r}else return"1"}).join("")).join("/").replace(/1{2,}/g,e=>e.length.toString())}function At(t,e){e.animation&&(je(t.animation,e.animation),(t.animation.duration||0)<70&&(t.animation.enabled=!1))}function It(t,e){var o,n,r;if(!((o=e.movable)===null||o===void 0)&&o.dests&&(t.movable.dests=void 0),!((n=e.drawable)===null||n===void 0)&&n.autoShapes&&(t.drawable.autoShapes=[]),je(t,e),e.fen&&(t.pieces=Tt(e.fen),t.drawable.shapes=((r=e.drawable)===null||r===void 0?void 0:r.shapes)||[]),"check"in e&&xo(t,e.check||!1),"lastMove"in e&&!e.lastMove?t.lastMove=void 0:e.lastMove&&(t.lastMove=e.lastMove),t.selected&&Et(t,t.selected),At(t,e),!t.movable.rookCastle&&t.movable.dests){const i=t.movable.color==="white"?"1":"8",a="e"+i,s=t.movable.dests.get(a),l=t.pieces.get(a);if(!s||!l||l.role!=="king")return;t.movable.dests.set(a,s.filter(c=>!(c==="a"+i&&s.includes("c"+i))&&!(c==="h"+i&&s.includes("g"+i))))}}function je(t,e){for(const o in e)Object.prototype.hasOwnProperty.call(e,o)&&(Object.prototype.hasOwnProperty.call(t,o)&&Xe(t[o])&&Xe(e[o])?je(t[o],e[o]):t[o]=e[o])}function Xe(t){if(typeof t!="object"||t===null)return!1;const e=Object.getPrototypeOf(t);return e===Object.prototype||e===null}const X=(t,e)=>e.animation.enabled?zo(t,e):U(t,e);function U(t,e){const o=t(e);return e.dom.redraw(),o}const Me=(t,e)=>({key:t,pos:k(t),piece:e}),Uo=(t,e)=>e.sort((o,n)=>pe(t.pos,o.pos)-pe(t.pos,n.pos))[0];function Go(t,e){const o=new Map,n=[],r=new Map,i=[],a=[],s=new Map;let l,c,u;for(const[p,h]of t)s.set(p,Me(p,h));for(const p of Re)l=e.pieces.get(p),c=s.get(p),l?c?Ne(l,c.piece)||(i.push(c),a.push(Me(p,l))):a.push(Me(p,l)):c&&i.push(c);for(const p of a)c=Uo(p,i.filter(h=>Ne(p.piece,h.piece))),c&&(u=[c.pos[0]-p.pos[0],c.pos[1]-p.pos[1]],o.set(p.key,u.concat(u)),n.push(c.key));for(const p of i)n.includes(p.key)||r.set(p.key,p.piece);return{anims:o,fadings:r}}function Nt(t,e){const o=t.animation.current;if(o===void 0){t.dom.destroyed||t.dom.redrawNow();return}const n=1-(e-o.start)*o.frequency;if(n<=0)t.animation.current=void 0,t.dom.redrawNow();else{const r=Zo(n);for(const i of o.plan.anims.values())i[2]=i[0]*r,i[3]=i[1]*r;t.dom.redrawNow(!0),requestAnimationFrame((i=performance.now())=>Nt(t,i))}}function zo(t,e){const o=new Map(e.pieces),n=t(e),r=Go(o,e);if(r.anims.size||r.fadings.size){const i=e.animation.current&&e.animation.current.start;e.animation.current={start:performance.now(),frequency:1/e.animation.duration,plan:r},i||Nt(e,performance.now())}else e.dom.redraw();return n}const Zo=t=>t<.5?4*t*t*t:(t-1)*(2*t-2)*(2*t-2)+1,Yo=["green","red","blue","yellow"];function Xo(t,e){if(e.touches&&e.touches.length>1)return;e.stopPropagation(),e.preventDefault(),e.ctrlKey?K(t):We(t);const o=te(e),n=oe(o,q(t),t.dom.bounds());n&&(t.drawable.current={orig:n,pos:o,brush:on(e),snapToValidMove:t.drawable.defaultSnapToValidMove},qt(t))}function qt(t){requestAnimationFrame(()=>{const e=t.drawable.current;if(e){const o=oe(e.pos,q(t),t.dom.bounds());o||(e.snapToValidMove=!1);const n=e.snapToValidMove?Wo(e.orig,e.pos,q(t),t.dom.bounds()):o;n!==e.mouseSq&&(e.mouseSq=n,e.dest=n!==e.orig?n:void 0,t.dom.redrawNow()),qt(t)}})}function Jo(t,e){t.drawable.current&&(t.drawable.current.pos=te(e))}function en(t){const e=t.drawable.current;e&&(e.mouseSq&&nn(t.drawable,e),xt(t))}function xt(t){t.drawable.current&&(t.drawable.current=void 0,t.dom.redraw())}function tn(t){t.drawable.shapes.length&&(t.drawable.shapes=[],t.dom.redraw(),Lt(t.drawable))}function on(t){var e;const o=(t.shiftKey||t.ctrlKey)&&ft(t),n=t.altKey||t.metaKey||((e=t.getModifierState)===null||e===void 0?void 0:e.call(t,"AltGraph"));return Yo[(o?1:0)+(n?2:0)]}function nn(t,e){const o=r=>r.orig===e.orig&&r.dest===e.dest,n=t.shapes.find(o);n&&(t.shapes=t.shapes.filter(r=>!o(r))),(!n||n.brush!==e.brush)&&t.shapes.push({orig:e.orig,dest:e.dest,brush:e.brush}),Lt(t)}function Lt(t){t.onChange&&t.onChange(t.shapes)}function rn(t,e){if(!(t.trustAllEvents||e.isTrusted)||e.button!==void 0&&e.button!==0||e.touches&&e.touches.length>1)return;const o=t.dom.bounds(),n=te(e),r=oe(n,q(t),o);if(!r)return;const i=t.pieces.get(r),a=t.selected;if(!a&&t.drawable.enabled&&(t.drawable.eraseOnClick||!i||i.color!==t.turnColor)&&tn(t),e.cancelable!==!1&&(!e.touches||t.blockTouchScroll||i||a||sn(t,n)))e.preventDefault();else if(e.touches)return;const s=!!t.premovable.current,l=!!t.predroppable.current;t.stats.ctrlKey=e.ctrlKey,t.selected&&Ve(t,t.selected,r)?X(p=>qe(p,r),t):qe(t,r);const c=t.selected===r,u=Ot(t,r);if(i&&u&&c&&Bo(t,r)){t.draggable.current={orig:r,piece:i,origPos:n,pos:n,started:t.draggable.autoDistance&&t.stats.dragged,element:u,previouslySelected:a,originTarget:e.target,keyHasChanged:!1},u.cgDragging=!0,u.classList.add("dragging");const p=t.dom.elements.ghost;p&&(p.className=`ghost ${i.color} ${i.role}`,V(p,fe(o)(k(r),q(t))),$e(p,!0)),Qe(t)}else s&&Z(t),l&&Y(t);t.dom.redraw()}function sn(t,e){const o=q(t),n=t.dom.bounds(),r=Math.pow(n.width/8,2);for(const i of t.pieces.keys()){const a=gt(i,o,n);if(pe(a,e)<=r)return!0}return!1}function an(t,e,o,n){const r="a0";t.pieces.set(r,e),t.dom.redraw();const i=te(o);t.draggable.current={orig:r,piece:e,origPos:i,pos:i,started:!0,element:()=>Ot(t,r),originTarget:o.target,newPiece:!0,force:!!n,keyHasChanged:!1},Qe(t)}function Qe(t){requestAnimationFrame(()=>{var e;const o=t.draggable.current;if(!o)return;!((e=t.animation.current)===null||e===void 0)&&e.plan.anims.has(o.orig)&&(t.animation.current=void 0);const n=t.pieces.get(o.orig);if(!n||!Ne(n,o.piece))ye(t);else if(!o.started&&pe(o.pos,o.origPos)>=Math.pow(t.draggable.distance,2)&&(o.started=!0),o.started){if(typeof o.element=="function"){const i=o.element();if(!i)return;i.cgDragging=!0,i.classList.add("dragging"),o.element=i}const r=t.dom.bounds();V(o.element,[o.pos[0]-r.left-r.width/16,o.pos[1]-r.top-r.height/16]),o.keyHasChanged||(o.keyHasChanged=o.orig!==oe(o.pos,q(t),r))}Qe(t)})}function ln(t,e){t.draggable.current&&(!e.touches||e.touches.length<2)&&(t.draggable.current.pos=te(e))}function cn(t,e){const o=t.draggable.current;if(!o)return;if(e.type==="touchend"&&e.cancelable!==!1&&e.preventDefault(),e.type==="touchend"&&o.originTarget!==e.target&&!o.newPiece){t.draggable.current=void 0;return}Z(t),Y(t);const n=te(e)||o.pos,r=oe(n,q(t),t.dom.bounds());r&&o.started&&o.orig!==r?o.newPiece?Ct(t,o.orig,r,o.force):(t.stats.ctrlKey=e.ctrlKey,St(t,o.orig,r)&&(t.stats.dragged=!0)):o.newPiece?t.pieces.delete(o.orig):t.draggable.deleteOnDropOff&&!r&&(t.pieces.delete(o.orig),N(t.events.change)),(o.orig===o.previouslySelected||o.keyHasChanged)&&(o.orig===r||!r)?K(t):t.selectable.enabled||K(t),Dt(t),t.draggable.current=void 0,t.dom.redraw()}function ye(t){const e=t.draggable.current;e&&(e.newPiece&&t.pieces.delete(e.orig),t.draggable.current=void 0,K(t),Dt(t),t.dom.redraw())}function Dt(t){const e=t.dom.elements;e.ghost&&$e(e.ghost,!1)}function Ot(t,e){let o=t.dom.elements.board.firstChild;for(;o;){if(o.cgKey===e&&o.tagName==="PIECE")return o;o=o.nextSibling}}function hn(t,e){t.exploding={stage:1,keys:e},t.dom.redraw(),setTimeout(()=>{Je(t,2),setTimeout(()=>Je(t,void 0),120)},120)}function Je(t,e){t.exploding&&(e?t.exploding.stage=e:t.exploding=void 0,t.dom.redraw())}function dn(t,e){function o(){No(t),e()}return{set(n){n.orientation&&n.orientation!==t.orientation&&o(),At(t,n),(n.fen?X:U)(r=>It(r,n),t)},state:t,getFen:()=>Ho(t.pieces),toggleOrientation:o,setPieces(n){X(r=>qo(r,n),t)},selectSquare(n,r){n?X(i=>qe(i,n,r),t):t.selected&&(K(t),t.dom.redraw())},move(n,r){X(i=>yt(i,n,r),t)},newPiece(n,r){X(i=>Be(i,n,r),t)},playPremove(){if(t.premovable.current){if(X(Vo,t))return!0;t.dom.redraw()}return!1},playPredrop(n){if(t.predroppable.current){const r=Fo(t,n);return t.dom.redraw(),r}return!1},cancelPremove(){U(Z,t)},cancelPredrop(){U(Y,t)},cancelMove(){U(n=>{We(n),ye(n)},t)},stop(){U(n=>{Ye(n),ye(n)},t)},explode(n){hn(t,n)},setAutoShapes(n){U(r=>r.drawable.autoShapes=n,t)},setShapes(n){U(r=>r.drawable.shapes=n,t)},getKeyAtDomPos(n){return oe(n,q(t),t.dom.bounds())},redrawAll:e,dragNewPiece(n,r,i){an(t,n,r,i)},destroy(){Ye(t),t.dom.unbind&&t.dom.unbind(),t.dom.destroyed=!0}}}function un(){return{pieces:Tt(Mt),orientation:"white",turnColor:"white",coordinates:!0,ranksPosition:"right",autoCastle:!0,viewOnly:!1,disableContextMenu:!1,addPieceZIndex:!1,blockTouchScroll:!1,pieceKey:!1,trustAllEvents:!1,highlight:{lastMove:!0,check:!0},animation:{enabled:!0,duration:200},movable:{free:!0,color:"both",showDests:!0,events:{},rookCastle:!0},premovable:{enabled:!0,showDests:!0,castle:!0,events:{}},predroppable:{enabled:!1,events:{}},draggable:{enabled:!0,distance:3,autoDistance:!0,showGhost:!0,deleteOnDropOff:!1},dropmode:{active:!1},selectable:{enabled:!0},stats:{dragged:!("ontouchstart"in window)},events:{},drawable:{enabled:!0,visible:!0,defaultSnapToValidMove:!0,eraseOnClick:!0,shapes:[],autoShapes:[],brushes:{green:{key:"g",color:"#15781B",opacity:1,lineWidth:10},red:{key:"r",color:"#882020",opacity:1,lineWidth:10},blue:{key:"b",color:"#003088",opacity:1,lineWidth:10},yellow:{key:"y",color:"#e68f00",opacity:1,lineWidth:10},paleBlue:{key:"pb",color:"#003088",opacity:.4,lineWidth:15},paleGreen:{key:"pg",color:"#15781B",opacity:.4,lineWidth:15},paleRed:{key:"pr",color:"#882020",opacity:.4,lineWidth:15},paleGrey:{key:"pgr",color:"#4a4a4a",opacity:.35,lineWidth:15},purple:{key:"purp",color:"#68217a",opacity:.65,lineWidth:10},pink:{key:"pink",color:"#ee2080",opacity:.5,lineWidth:10},hilite:{key:"hilite",color:"#fff",opacity:1,lineWidth:1}},prevSvgHash:""},hold:Mo()}}function pn(){const t=C("defs"),e=A(C("filter"),{id:"cg-filter-blur"});return e.appendChild(A(C("feGaussianBlur"),{stdDeviation:"0.022"})),t.appendChild(e),t}function fn(t,e,o){var n;const r=t.drawable,i=r.current,a=i&&i.mouseSq?i:void 0,s=new Map,l=t.dom.bounds(),c=r.autoShapes.filter(m=>!m.piece);for(const m of r.shapes.concat(c).concat(a?[a]:[])){if(!m.dest)continue;const d=(n=s.get(m.dest))!==null&&n!==void 0?n:new Set,f=Se(ke(k(m.orig),t.orientation),l),_=Se(ke(k(m.dest),t.orientation),l);d.add(Le(f,_)),s.set(m.dest,d)}const u=r.shapes.concat(c).map(m=>({shape:m,current:!1,hash:et(m,xe(m.dest,s),!1,l)}));a&&u.push({shape:a,current:!0,hash:et(a,xe(a.dest,s),!0,l)});const p=u.map(m=>m.hash).join(";");if(p===t.drawable.prevSvgHash)return;t.drawable.prevSvgHash=p;const h=e.querySelector("defs");gn(r,u,h),mn(u,e.querySelector("g"),o.querySelector("g"),m=>_n(t,m,r.brushes,s,l))}function gn(t,e,o){var n;const r=new Map;let i;for(const l of e.filter(c=>c.shape.dest&&c.shape.brush))i=Rt(t.brushes[l.shape.brush],l.shape.modifiers),!((n=l.shape.modifiers)===null||n===void 0)&&n.hilite&&r.set("hilite",t.brushes.hilite),r.set(i.key,i);const a=new Set;let s=o.firstElementChild;for(;s;)a.add(s.getAttribute("cgKey")),s=s.nextElementSibling;for(const[l,c]of r.entries())a.has(l)||o.appendChild(kn(c))}function mn(t,e,o,n){const r=new Map;for(const i of t)r.set(i.hash,!1);for(const i of[e,o]){const a=[];let s=i.firstElementChild,l;for(;s;)l=s.getAttribute("cgHash"),r.has(l)?r.set(l,!0):a.push(s),s=s.nextElementSibling;for(const c of a)i.removeChild(c)}for(const i of t.filter(a=>!r.get(a.hash)))for(const a of n(i))a.isCustom?o.appendChild(a.el):e.appendChild(a.el)}function et({orig:t,dest:e,brush:o,piece:n,modifiers:r,customSvg:i,label:a},s,l,c){var u,p;return[c.width,c.height,l,t,e,o,s&&"-",n&&bn(n),r&&vn(r),i&&`custom-${tt(i.html)},${(p=(u=i.center)===null||u===void 0?void 0:u[0])!==null&&p!==void 0?p:"o"}`,a&&`label-${tt(a.text)}`].filter(h=>h).join(",")}function bn(t){return[t.color,t.role,t.scale].filter(e=>e).join(",")}function vn(t){return[t.lineWidth,t.hilite&&"*"].filter(e=>e).join(",")}function tt(t){let e=0;for(let o=0;o<t.length;o++)e=(e<<5)-e+t.charCodeAt(o)>>>0;return e.toString()}function _n(t,{shape:e,current:o,hash:n},r,i,a){var s,l;const c=Se(ke(k(e.orig),t.orientation),a),u=e.dest?Se(ke(k(e.dest),t.orientation),a):c,p=e.brush&&Rt(r[e.brush],e.modifiers),h=i.get(e.dest),m=[];if(p){const d=A(C("g"),{cgHash:n});m.push({el:d}),c[0]!==u[0]||c[1]!==u[1]?d.appendChild(yn(e,p,c,u,o,xe(e.dest,i))):d.appendChild(wn(r[e.brush],c,o,a))}if(e.label){const d=e.label;(s=d.fill)!==null&&s!==void 0||(d.fill=e.brush&&r[e.brush].color);const f=e.brush?void 0:"tr";m.push({el:Sn(d,n,c,u,h,f),isCustom:!0})}if(e.customSvg){const d=(l=e.customSvg.center)!==null&&l!==void 0?l:"orig",[f,_]=d==="label"?$t(c,u,h).map(g=>g-.5):d==="dest"?u:c,y=A(C("g"),{transform:`translate(${f},${_})`,cgHash:n});y.innerHTML=`<svg width="1" height="1" viewBox="0 0 100 100">${e.customSvg.html}</svg>`,m.push({el:y,isCustom:!0})}return m}function wn(t,e,o,n){const r=Cn(),i=(n.width+n.height)/(4*Math.max(n.width,n.height));return A(C("circle"),{stroke:t.color,"stroke-width":r[o?0:1],fill:"none",opacity:Kt(t,o),cx:e[0],cy:e[1],r:i-r[1]/2})}function yn(t,e,o,n,r,i){var a;function s(u){var p;const h=Pn(i&&!r),m=n[0]-o[0],d=n[1]-o[1],f=Math.atan2(d,m),_=Math.cos(f)*h,y=Math.sin(f)*h;return A(C("line"),{stroke:u?"white":e.color,"stroke-width":En(e,r)+(u?.04:0),"stroke-linecap":"round","marker-end":`url(#arrowhead-${u?"hilite":e.key})`,opacity:!((p=t.modifiers)===null||p===void 0)&&p.hilite?1:Kt(e,r),x1:o[0],y1:o[1],x2:n[0]-_,y2:n[1]-y})}if(!(!((a=t.modifiers)===null||a===void 0)&&a.hilite))return s(!1);const l=C("g"),c=A(C("g"),{filter:"url(#cg-filter-blur)"});return c.appendChild(Mn(o,n)),c.appendChild(s(!0)),l.appendChild(c),l.appendChild(s(!1)),l}function kn(t){const e=A(C("marker"),{id:"arrowhead-"+t.key,orient:"auto",overflow:"visible",markerWidth:4,markerHeight:4,refX:t.key==="hilite"?1.86:2.05,refY:2});return e.appendChild(A(C("path"),{d:"M0,0 V4 L3,2 Z",fill:t.color})),e.setAttribute("cgKey",t.key),e}function Sn(t,e,o,n,r,i){var a;const s=.4*.75**t.text.length,l=$t(o,n,r),c=i==="tr"?.4:0,u=A(C("g"),{transform:`translate(${l[0]+c},${l[1]-c})`,cgHash:e});u.appendChild(A(C("circle"),{r:.4/2,"fill-opacity":i?1:.8,"stroke-opacity":i?1:.7,"stroke-width":.03,fill:(a=t.fill)!==null&&a!==void 0?a:"#666",stroke:"white"}));const p=A(C("text"),{"font-size":s,"font-family":"Noto Sans","text-anchor":"middle",fill:"white",y:.13*.75**t.text.length});return p.innerHTML=t.text,u.appendChild(p),u}function ke(t,e){return e==="white"?t:[7-t[0],7-t[1]]}function xe(t,e){return(t&&e.has(t)&&e.get(t).size>1)===!0}function C(t){return document.createElementNS("http://www.w3.org/2000/svg",t)}function A(t,e){for(const o in e)Object.prototype.hasOwnProperty.call(e,o)&&t.setAttribute(o,e[o]);return t}function Rt(t,e){return e?{color:t.color,opacity:Math.round(t.opacity*10)/10,lineWidth:Math.round(e.lineWidth||t.lineWidth),key:[t.key,e.lineWidth].filter(o=>o).join("")}:t}function Cn(){return[3/64,4/64]}function En(t,e){return(t.lineWidth||10)*(e?.85:1)/64}function Kt(t,e){return(t.opacity||1)*(e?.9:1)}function Pn(t){return(t?20:10)/64}function Se(t,e){const o=Math.min(1,e.width/e.height),n=Math.min(1,e.height/e.width);return[(t[0]-3.5)*o,(3.5-t[1])*n]}function Mn(t,e){const o={from:[Math.floor(Math.min(t[0],e[0])),Math.floor(Math.min(t[1],e[1]))],to:[Math.ceil(Math.max(t[0],e[0])),Math.ceil(Math.max(t[1],e[1]))]};return A(C("rect"),{x:o.from[0],y:o.from[1],width:o.to[0]-o.from[0],height:o.to[1]-o.from[1],fill:"none",stroke:"none"})}function Le(t,e,o=!0){const n=Math.atan2(e[1]-t[1],e[0]-t[0])+Math.PI;return o?(Math.round(n*8/Math.PI)+16)%16:n}function Tn(t,e){return Math.sqrt([t[0]-e[0],t[1]-e[1]].reduce((o,n)=>o+n*n,0))}function $t(t,e,o){let n=Tn(t,e);const r=Le(t,e,!1);if(o&&(n-=33/64,o.size>1)){n-=10/64;const i=Le(t,e);(o.has((i+1)%16)||o.has((i+15)%16))&&i&1&&(n-=.4)}return[t[0]-Math.cos(r)*n,t[1]-Math.sin(r)*n].map(i=>i+.5)}function An(t,e){t.innerHTML="",t.classList.add("cg-wrap");for(const l of Co)t.classList.toggle("orientation-"+l,e.orientation===l);t.classList.toggle("manipulable",!e.viewOnly);const o=j("cg-container");t.appendChild(o);const n=j("cg-board");o.appendChild(n);let r,i,a;if(e.drawable.visible&&(r=A(C("svg"),{class:"cg-shapes",viewBox:"-4 -4 8 8",preserveAspectRatio:"xMidYMid slice"}),r.appendChild(pn()),r.appendChild(C("g")),i=A(C("svg"),{class:"cg-custom-svgs",viewBox:"-3.5 -3.5 8 8",preserveAspectRatio:"xMidYMid slice"}),i.appendChild(C("g")),a=j("cg-auto-pieces"),o.appendChild(r),o.appendChild(i),o.appendChild(a)),e.coordinates){const l=e.orientation==="black"?" black":"",c=e.ranksPosition==="left"?" left":"";o.appendChild(ot(Oe,"ranks"+l+c)),o.appendChild(ot(De,"files"+l))}let s;return e.draggable.enabled&&e.draggable.showGhost&&(s=j("piece","ghost"),$e(s,!1),o.appendChild(s)),{board:n,container:o,wrap:t,ghost:s,svg:r,customSvg:i,autoPieces:a}}function ot(t,e){const o=j("coords",e);let n;for(const r of t)n=j("coord"),n.textContent=r,o.appendChild(n);return o}function In(t,e){if(!t.dropmode.active)return;Z(t),Y(t);const o=t.dropmode.piece;if(o){t.pieces.set("a0",o);const n=te(e),r=n&&oe(n,q(t),t.dom.bounds());r&&Ct(t,"a0",r)}t.dom.redraw()}function Nn(t,e){const o=t.dom.elements.board;if("ResizeObserver"in window&&new ResizeObserver(e).observe(t.dom.elements.wrap),(t.disableContextMenu||t.drawable.enabled)&&o.addEventListener("contextmenu",r=>r.preventDefault()),t.viewOnly)return;const n=xn(t);o.addEventListener("touchstart",n,{passive:!1}),o.addEventListener("mousedown",n,{passive:!1})}function qn(t,e){const o=[];if("ResizeObserver"in window||o.push(le(document.body,"chessground.resize",e)),!t.viewOnly){const n=nt(t,ln,Jo),r=nt(t,cn,en);for(const a of["touchmove","mousemove"])o.push(le(document,a,n));for(const a of["touchend","mouseup"])o.push(le(document,a,r));const i=()=>t.dom.bounds.clear();o.push(le(document,"scroll",i,{capture:!0,passive:!0})),o.push(le(window,"resize",i,{passive:!0}))}return()=>o.forEach(n=>n())}function le(t,e,o,n){return t.addEventListener(e,o,n),()=>t.removeEventListener(e,o,n)}const xn=t=>e=>{t.draggable.current?ye(t):t.drawable.current?xt(t):e.shiftKey||ft(e)?t.drawable.enabled&&Xo(t,e):t.viewOnly||(t.dropmode.active?In(t,e):rn(t,e))},nt=(t,e,o)=>n=>{t.drawable.current?t.drawable.enabled&&o(t,n):t.viewOnly||e(t,n)};function Ln(t){const e=q(t),o=fe(t.dom.bounds()),n=t.dom.elements.board,r=t.pieces,i=t.animation.current,a=i?i.plan.anims:new Map,s=i?i.plan.fadings:new Map,l=t.draggable.current,c=On(t),u=new Set,p=new Set,h=new Map,m=new Map;let d,f,_,y,g,S,D,I,ne,F;for(f=n.firstChild;f;){if(d=f.cgKey,Bt(f))if(_=r.get(d),g=a.get(d),S=s.get(d),y=f.cgPiece,f.cgDragging&&(!l||l.orig!==d)&&(f.classList.remove("dragging"),V(f,o(k(d),e)),f.cgDragging=!1),!S&&f.cgFading&&(f.cgFading=!1,f.classList.remove("fading")),_){if(g&&f.cgAnimating&&y===ce(_)){const w=k(d);w[0]+=g[2],w[1]+=g[3],f.classList.add("anim"),V(f,o(w,e))}else f.cgAnimating&&(f.cgAnimating=!1,f.classList.remove("anim"),V(f,o(k(d),e)),t.addPieceZIndex&&(f.style.zIndex=Te(k(d),e)));y===ce(_)&&(!S||!f.cgFading)?u.add(d):S&&y===ce(S)?(f.classList.add("fading"),f.cgFading=!0):Ae(h,y,f)}else Ae(h,y,f);else if(Vt(f)){const w=f.className;c.get(d)===w?p.add(d):Ae(m,w,f)}f=f.nextSibling}for(const[w,ie]of c)if(!p.has(w)){ne=m.get(ie),F=ne&&ne.pop();const $=o(k(w),e);if(F)F.cgKey=w,V(F,$);else{const B=j("square",ie);B.cgKey=w,V(B,$),n.insertBefore(B,n.firstChild)}}for(const[w,ie]of r)if(g=a.get(w),!u.has(w))if(D=h.get(ce(ie)),I=D&&D.pop(),I){I.cgKey=w,I.cgFading&&(I.classList.remove("fading"),I.cgFading=!1);const $=k(w);t.addPieceZIndex&&(I.style.zIndex=Te($,e)),g&&(I.cgAnimating=!0,I.classList.add("anim"),$[0]+=g[2],$[1]+=g[3]),V(I,o($,e))}else{const $=ce(ie),B=j("piece",$),ge=k(w);B.cgPiece=$,B.cgKey=w,g&&(B.cgAnimating=!0,ge[0]+=g[2],ge[1]+=g[3]),V(B,o(ge,e)),t.addPieceZIndex&&(B.style.zIndex=Te(ge,e)),n.appendChild(B)}for(const w of h.values())it(t,w);for(const w of m.values())it(t,w)}function Dn(t){const e=q(t),o=fe(t.dom.bounds());let n=t.dom.elements.board.firstChild;for(;n;)(Bt(n)&&!n.cgAnimating||Vt(n))&&V(n,o(k(n.cgKey),e)),n=n.nextSibling}function rt(t){var e,o;const n=t.dom.elements.wrap.getBoundingClientRect(),r=t.dom.elements.container,i=n.height/n.width,a=Math.floor(n.width*window.devicePixelRatio/8)*8/window.devicePixelRatio,s=a*i;r.style.width=a+"px",r.style.height=s+"px",t.dom.bounds.clear(),(e=t.addDimensionsCssVarsTo)===null||e===void 0||e.style.setProperty("--cg-width",a+"px"),(o=t.addDimensionsCssVarsTo)===null||o===void 0||o.style.setProperty("--cg-height",s+"px")}const Bt=t=>t.tagName==="PIECE",Vt=t=>t.tagName==="SQUARE";function it(t,e){for(const o of e)t.dom.elements.board.removeChild(o)}function Te(t,e){const o=t[1];return`${e?10-o:3+o}`}const ce=t=>`${t.color} ${t.role}`;function On(t){var e,o,n;const r=new Map;if(t.lastMove&&t.highlight.lastMove)for(const s of t.lastMove)W(r,s,"last-move");if(t.check&&t.highlight.check&&W(r,t.check,"check"),t.selected&&(W(r,t.selected,"selected"),t.movable.showDests)){const s=(e=t.movable.dests)===null||e===void 0?void 0:e.get(t.selected);if(s)for(const c of s)W(r,c,"move-dest"+(t.pieces.has(c)?" oc":""));const l=(n=(o=t.premovable.customDests)===null||o===void 0?void 0:o.get(t.selected))!==null&&n!==void 0?n:t.premovable.dests;if(l)for(const c of l)W(r,c,"premove-dest"+(t.pieces.has(c)?" oc":""))}const i=t.premovable.current;if(i)for(const s of i)W(r,s,"current-premove");else t.predroppable.current&&W(r,t.predroppable.current.key,"current-premove");const a=t.exploding;if(a)for(const s of a.keys)W(r,s,"exploding"+a.stage);return t.highlight.custom&&t.highlight.custom.forEach((s,l)=>{W(r,l,s)}),r}function W(t,e,o){const n=t.get(e);n?t.set(e,`${n} ${o}`):t.set(e,o)}function Ae(t,e,o){const n=t.get(e);n?n.push(o):t.set(e,[o])}function Rn(t,e,o){const n=new Map,r=[];for(const s of t)n.set(s.hash,!1);let i=e.firstElementChild,a;for(;i;)a=i.getAttribute("cgHash"),n.has(a)?n.set(a,!0):r.push(i),i=i.nextElementSibling;for(const s of r)e.removeChild(s);for(const s of t)n.get(s.hash)||e.appendChild(o(s))}function Kn(t,e){const o=t.drawable.autoShapes.filter(n=>n.piece).map(n=>({shape:n,hash:Vn(n),current:!1}));Rn(o,e,n=>Bn(t,n,t.dom.bounds()))}function $n(t){var e;const o=q(t),n=fe(t.dom.bounds());let r=(e=t.dom.elements.autoPieces)===null||e===void 0?void 0:e.firstChild;for(;r;)pt(r,n(k(r.cgKey),o),r.cgScale),r=r.nextSibling}function Bn(t,{shape:e,hash:o},n){var r,i,a;const s=e.orig,l=(r=e.piece)===null||r===void 0?void 0:r.role,c=(i=e.piece)===null||i===void 0?void 0:i.color,u=(a=e.piece)===null||a===void 0?void 0:a.scale,p=j("piece",`${l} ${c}`);return p.setAttribute("cgHash",o),p.cgKey=s,p.cgScale=u,pt(p,fe(n)(k(s),q(t)),u),p}const Vn=t=>{var e,o,n;return[t.orig,(e=t.piece)===null||e===void 0?void 0:e.role,(o=t.piece)===null||o===void 0?void 0:o.color,(n=t.piece)===null||n===void 0?void 0:n.scale].join(",")};function Fn(t,e){const o=un();It(o,e||{});function n(){const r="dom"in o?o.dom.unbind:void 0,i=An(t,o),a=Po(()=>i.board.getBoundingClientRect()),s=u=>{Ln(c),i.autoPieces&&Kn(c,i.autoPieces),!u&&i.svg&&fn(c,i.svg,i.customSvg)},l=()=>{rt(c),Dn(c),i.autoPieces&&$n(c)},c=o;return c.dom={elements:i,bounds:a,redraw:Wn(s),redrawNow:s,unbind:r},c.drawable.prevSvgHash="",rt(c),s(!1),Nn(c,l),r||(c.dom.unbind=qn(c,l)),c.events.insert&&c.events.insert(i),c}return dn(n(),n)}function Wn(t){let e=!1;return()=>{e||(e=!0,requestAnimationFrame(()=>{t(),e=!1}))}}class jn{constructor(e,o,n,r){M(this,"game");M(this,"board");M(this,"boardState");M(this,"props");M(this,"emit");this.boardState=o,this.props=n,this.emit=r,this.game=new bo,this.board=Fn(e),this.resetBoard()}updateGameState({updateFen:e=!0}={}){this.boardState.historyViewerState.isEnabled||(e&&this.board.set({fen:this.game.fen()}),this.board.state.turnColor=this.getTurnColor(),this.board.state.movable.free?(this.board.state.movable.color="both",this.board.state.movable.dests=new Map):(this.board.state.movable.color=this.props.playerColor||this.board.state.turnColor,this.board.state.movable.dests=Ze(this.game)),this.displayInCheck(this.game.inCheck(),this.board.state.turnColor),this.boardState.showThreats&&this.drawMoves()),this.emitEvents()}displayInCheck(e,o){if(e){for(const[n,r]of this.board.state.pieces)if(r.role==="king"&&r.color===o){this.board.state.check=n;return}}else this.board.state.check=void 0}emitEvents(){this.game.inCheck()&&this.emit(this.game.isCheckmate()?"checkmate":"check",this.board.state.turnColor),this.game.isDraw()&&this.emit("draw"),this.game.isStalemate()&&this.emit("stalemate")}async changeTurn(e,o,n){let r;_o(o,this.game.get(e))&&(r=await new Promise(i=>{this.boardState.promotionDialogState={isEnabled:!0,color:this.getTurnColor(),callback:i}})),this.move({from:e,to:o,promotion:r})}resetBoard(){this.setConfig(this.props.boardConfig,!0)}undoLastMove(){const e=this.game.undo();if(e!=null&&(this.boardState.historyViewerState.isEnabled&&this.boardState.historyViewerState.plyViewing===this.getCurrentPlyNumber()&&this.stopViewingHistory(),!this.boardState.historyViewerState.isEnabled)){this.board.set({fen:e.before}),this.updateGameState({updateFen:!1});const o=this.getLastMove();this.board.state.lastMove=o?[o==null?void 0:o.from,o==null?void 0:o.to]:void 0}}getMaterialCount(){const e=this.board.state.pieces,o={pawn:1,knight:3,bishop:3,rook:5,queen:9,king:0},n={materialWhite:0,materialBlack:0,materialDiff:0};for(const r of e)r[1].color==="white"?n.materialWhite+=o[r[1].role]:n.materialBlack+=o[r[1].role];return n.materialDiff=n.materialWhite-n.materialBlack,n}getCapturedPieces(){const e={white:[],black:[]};for(const{color:o,captured:n}of this.getHistory(!0))n&&e[be(o)].push(n);return e}toggleOrientation(){this.board.toggleOrientation()}drawMoves(){this.boardState.showThreats=!0,this.board.setShapes(vo(this.game.moves({verbose:!0})))}hideMoves(){this.boardState.showThreats=!1,this.board.setShapes([])}drawMove(e,o,n){this.board.setShapes([{orig:e,dest:o,brush:n}])}toggleMoves(){this.boardState.showThreats?this.hideMoves():this.drawMoves()}async getOpeningName(){var e;try{const o=this.game.history({verbose:!0}).map(n=>n.lan).join(",");return((e=(await(await fetch(`https://explorer.lichess.ovh/masters?play=${o}`)).json()).opening)==null?void 0:e.name)??null}catch{return null}}move(e){let o;try{o=this.game.move(e)}catch{return typeof e=="object"&&this.board.state.movable.free&&(this.board.move(e.from,e.to),this.updateGameState({updateFen:!1})),!1}return this.emit("move",o),o!=null&&o.promotion&&this.emit("promotion",{color:be(o.color),promotedTo:o.promotion.toUpperCase(),sanMove:o.san}),this.boardState.historyViewerState.isEnabled||(this.board.move(o.from,o.to),(o.flags==="e"||o!=null&&o.promotion)&&setTimeout(()=>this.board.set({fen:o.after}),this.board.state.animation.current?this.board.state.animation.duration:0),this.updateGameState({updateFen:!1}),Zt(this.board.playPremove)),!0}getTurnColor(){return be(this.game.turn())}getPossibleMoves(){return Ze(this.game)}getCurrentTurnNumber(){return this.game.moveNumber()}getCurrentPlyNumber(){return 2*this.getCurrentTurnNumber()-(this.getTurnColor()==="black"?1:2)}getLastMove(){return this.game.history({verbose:!0}).at(-1)}getHistory(e=!1){return this.game.history({verbose:e})}getFen(){return this.game.fen()}getBoardPosition(){return this.game.board()}getPgn(){return this.game.pgn()}getIsGameOver(){return this.game.isGameOver()}getIsCheckmate(){return this.game.isCheckmate()}getIsCheck(){return this.game.isCheck()}getIsStalemate(){return this.game.isStalemate()}getIsDraw(){return this.game.isDraw()}getIsThreefoldRepetition(){return this.game.isThreefoldRepetition()}getIsInsufficientMaterial(){return this.game.isInsufficientMaterial()}getSquareColor(e){return this.game.squareColor(e)}getSquare(e){return this.game.get(e)}setPosition(e){this.game.load(e),this.boardState.historyViewerState={isEnabled:!1},this.updateGameState()}putPiece(e,o){if(this.board.state.movable.free){const n=this.board.state.pieces;return n.set(o,{color:e.color==="w"?"white":"black",role:wo[e.type]}),this.board.setPieces(n),!0}else{const n=this.game.put(e,o);return n&&this.updateGameState(),n}}removePiece(e){this.board.state.pieces.delete(e),this.game.remove(e)}clearBoard(){this.game.clear(),this.boardState.historyViewerState={isEnabled:!1},this.updateGameState()}setShapes(e){this.board.setShapes(e)}loadPgn(e){this.game.loadPgn(e),this.boardState.historyViewerState={isEnabled:!1},this.updateGameState();const o=this.getLastMove();o&&this.board.set({lastMove:[o.from,o.to]})}getPgnInfo(){return this.game.header()}setPgnInfo(e){return this.game.header(...Object.entries(e).flat())}setConfig(e,o=!1){var i;if(o&&(e=ht(So,e),this.board.state.selected=void 0),((i=e.movable)==null?void 0:i.events)&&"after"in e.movable.events){const a=e.movable.events.after;e.movable.events.after=a?async(...s)=>{await this.changeTurn(...s),a(...s)}:this.changeTurn.bind(this)}const{fen:n,...r}=e;this.board.set(r),n&&this.setPosition(n),this.board.redrawAll()}viewHistory(e){const o=this.getHistory(!0);if(e<0||e>o.length)return;const n=this.board.state.animation.enabled&&(this.boardState.historyViewerState.isEnabled&&Math.abs(this.boardState.historyViewerState.plyViewing-e)!==1||!this.boardState.historyViewerState.isEnabled&&e!==o.length-1);if(n&&this.board.set({animation:{enabled:!1}}),e<o.length)this.boardState.historyViewerState.isEnabled?this.boardState.historyViewerState.plyViewing=e:this.boardState.historyViewerState={isEnabled:!0,plyViewing:e,viewOnly:this.board.state.viewOnly},this.board.set({fen:o[e].before,viewOnly:!0,lastMove:e>0?[o[e-1].from,o[e-1].to]:void 0,selected:void 0}),this.displayInCheck(e>0?"+#".includes(o[e-1].san.at(-1)):!1,be(o[e].color)),this.board.cancelPremove();else if(this.boardState.historyViewerState.isEnabled){const r=o.at(-1);this.board.set({fen:r.after,viewOnly:this.boardState.historyViewerState.viewOnly,lastMove:[r.from,r.to]}),this.boardState.historyViewerState={isEnabled:!1},this.updateGameState({updateFen:!1})}n&&this.board.set({animation:{enabled:!0}})}stopViewingHistory(){this.boardState.historyViewerState.isEnabled&&this.viewHistory(this.getCurrentPlyNumber())}viewStart(){this.viewHistory(0)}viewNext(){this.boardState.historyViewerState.isEnabled&&this.viewHistory(this.boardState.historyViewerState.plyViewing+1)}viewPrevious(){const e=this.boardState.historyViewerState.isEnabled?this.boardState.historyViewerState.plyViewing:this.getCurrentPlyNumber();this.viewHistory(e-1)}}const Qn={class:"main-board"},Hn=st({__name:"TheChessboard",props:{boardConfig:{default:()=>({})},playerColor:{},reactiveConfig:{type:Boolean,default:!1}},emits:["boardCreated","check","checkmate","stalemate","draw","promotion","move"],setup(t,{emit:e}){const o=t,n=jt(null),r=He({showThreats:!1,promotionDialogState:{isEnabled:!1},historyViewerState:{isEnabled:!1}});return Qt(()=>{if(n.value==null)throw new Error("vue3-chessboard: Failed to mount board.");const i=new jn(n.value,r,o,e);if(e("boardCreated",i),o.reactiveConfig){let a=we(o.boardConfig);Ht(He(o.boardConfig),s=>{i.setConfig(dt(a,s)),a=we(s)})}}),(i,a)=>(re(),_e("section",{class:lt(["main-wrap",{disabledBoard:r.promotionDialogState.isEnabled,viewingHistory:r.historyViewerState.isEnabled}])},[z("div",Qn,[r.promotionDialogState.isEnabled?(re(),at(to,{key:0,state:r.promotionDialogState,onPromotionSelected:a[0]||(a[0]=s=>r.promotionDialogState={isEnabled:!1})},null,8,["state"])):Ut("",!0),z("div",{ref_key:"boardElement",ref:n},null,512)])],2))}}),Un={__name:"Chess",setup(t){let e;const o={coordinates:!0,fen:"rnbqkbnr/pp2pppp/8/2pp4/4PP2/8/PPPP2PP/RNBQKBNR b KQkq - 0 3"};function n(s){console.log(s),alert(s==="black"?"White wins!":"Black wins!")}function r(s){console.log(s,"draw")}function i(s){console.log(s),e=s}function a(s){console.log(e),console.log(s)}return(s,l)=>(re(),_e("section",null,[z("div",null,[z("button",{onClick:l[0]||(l[0]=c=>{var u;return(u=se(e))==null?void 0:u.toggleOrientation()})},"Toggle orientation"),z("button",{onClick:l[1]||(l[1]=c=>{var u;return(u=se(e))==null?void 0:u.resetBoard()})},"Reset"),z("button",{onClick:l[2]||(l[2]=c=>{var u;return(u=se(e))==null?void 0:u.undoLastMove()})},"Undo"),z("button",{onClick:l[3]||(l[3]=c=>{var u;return(u=se(e))==null?void 0:u.toggleMoves()})},"Threats")]),Yt(se(Hn),{"board-config":o,onBoardCreated:i,onCheckmate:n,onMove:a,onDraw:r})]))}},Gn=Un,zn={};function Zn(t,e){const o=Gn;return re(),at(o)}const er=Xt(zn,[["render",Zn]]);export{er as default};
